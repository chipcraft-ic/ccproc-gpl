/*H*****************************************************************************
*
* Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, version 2.
*
* This program is distributed in the hope that it will be useful, but
* WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
* General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>
*
* ******************************************************************************
* File Name : romgen.c
* Author    : Krzysztof Marcinek
* ******************************************************************************
* $Date: 2019-03-14 14:47:55 +0100 (Thu, 14 Mar 2019) $
* $Revision: 427 $
*H*****************************************************************************/

#include <dirent.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char * argv[]) {
    FILE * f;
    FILE * r;
    int i = 0;

    char data[20];
    char res[10];

    if (argc < 2) {
        printf("too few arguments\n");
        exit(1);
    }

    f = fopen("boot_mem_case.v", "w");
    if (!f) {
        printf("could not open file boot_mem_case.v\n");
        exit(1);
    }

    r = fopen(argv[1], "r");
    if (!r) {
        printf("could not open %s\n", argv[1]);
        exit(1);
    }

    fprintf(f, "// +FHDR------------------------------------------------------------------------\n\
//\n\
// Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved\n\
//\n\
// -----------------------------------------------------------------------------\n\
// File Name : boot_mem_case.v\n\
// Author    : Krzysztof Marcinek\n\
// -----------------------------------------------------------------------------\n\
// Automatically generated by tkonfig/romgen\n\
// -FHDR------------------------------------------------------------------------\n\");"

    fprintf(f, "\n`include \"timescale.inc\"\n`include \"configdef.vh\"\n\nmodule boot_mem_case(clk, cs, addr, data);\n\n`include \"configpar.vh\"\n"); fprintf(f, "\ninput wire                          clk;\ninput wire                          cs;\ninput wire  [CFG_BOOT_SIZE-1:0]     addr;\noutput reg  [`WIDTH-1:0]            data;\n\nreg         [CFG_BOOT_SIZE-1:0]     r_addr;\n\n"); fprintf(f, "always @(posedge clk)\nbegin\n    if (cs) begin\n        r_addr <= addr;\n    end\nend\n\n"); fprintf(f, "always @(*)\nbegin\n    case (r_addr)\n");

    while (fgets(data, sizeof(data), r)) {
        strncpy(res, data, 8);
        fprintf(f, "        %d:  data = 32'h%s;\n", i, res);
        i++;
    }
    fprintf(f, "   default:  data = 32'h00000000;\n    endcase\nend\n");

    fprintf(f, "\nendmodule\n");

    fclose(f); fclose(r);

}
