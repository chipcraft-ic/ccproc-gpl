/*H*****************************************************************************
*
* Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, version 2.
*
* This program is distributed in the hope that it will be useful, but
* WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
* General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>
*
* ******************************************************************************
* File Name : mkmbist.c
* Author    : Krzysztof Marcinek
* ******************************************************************************
* $Date: 2019-03-25 12:58:07 +0100 (Mon, 25 Mar 2019) $
* $Revision: 439 $
*H*****************************************************************************/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <math.h>

#define MAX  300
#define LMAX 500

FILE *fp_configval;
FILE *fp_mbistconfig;

char cfgarray[2][MAX][MAX];
char line[MAX];
char cfgstart[MAX];
char cfgline[LMAX];
char cfgcmd[MAX];

char* token;

int i, j, val;
int regions_number = 0;
int regions_dualport = 0;
int regions_num = 0;
int regions_addr_range = 0;
int corenum_log = 0;

int spram_en = 0;
int gnss_en = 0;
int gnss_fifo_size = 0;
int gnss_ise_en;
int gnss_ise_size;
int fpu_en = 0;
int fft_size = 0;
int icache_en = 0;
int dcache_en = 0;
int fft_en = 0;
int eth_num = 0;
int eth_size = 0;
int data_width = 0;
int seed_mult = 0;

int rows = 0;

char *replace_str(char *str, char *orig, char *rep)
{
    static char buffer[4096];
    char *p;

    if(!(p = strstr(str, orig)))
        return str;

    strncpy(buffer, str, p-str);
    buffer[p-str] = '\0';

    sprintf(buffer+(p-str), "%s%s", rep, p+strlen(orig));

    return buffer;
}

void replsemi(char *data){
    int i;
    for(i = 0; i < strlen(data); i++)
    {
        if (data[i] == ';')
            data[i] = '\0';
    }
}

int cfgfind(char *str, char(*const p)[2][MAX][MAX]){
    #define data (*p)
    int i;
    for (i=0;i<MAX;i++){
        if (strcmp(str,data[0][i]) == 0){
            return atoi(data[1][i]);
        }
    }
    return -1;
    #undef data
}

int main(int argc, char *argv[])
{

    if (argc < 2){
        printf("Too few arguments. Configuration file required.\n");
        exit(1);
    }
    fp_configval = fopen(argv[1], "r");
    if (!fp_configval) {
        printf("could not open file configuration file.\n");
        exit(1);
    }
    fp_mbistconfig = fopen("configmbist.vh","w+");
    if (!fp_mbistconfig) {
        printf("could not open file mbist file.\n");
        exit(1);
    }

    i = 0;
    while(fgets(line,sizeof(line),fp_configval)){
        sprintf(line,"%s",replace_str(line, "[31:0] ", ""));
        sprintf(line,"%s",replace_str(line, "32'd", ""));
        if (strstr(line,"parameter") != NULL){
            token = strtok(line, " ");
            if (token) {
                token = strtok(NULL, " ");
                strcpy(cfgarray[0][i],token);
                if (token){
                    token = strtok(NULL, " ");
                    if (token){
                        token = strtok(NULL, " ");
                        if (token){
                            strcpy(cfgarray[1][i],token);
                            replsemi(cfgarray[1][i]);
                        }
                    }
                }
            }
        }
        i++;
        if (i==MAX){
            printf("Too many configuration parameters\n");
            //exit(1);
            break;
        }

    }

    fprintf(fp_mbistconfig, "// +FHDR------------------------------------------------------------------------\n\
//\n\
// Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved\n\
//\n\
// -----------------------------------------------------------------------------\n\
// File Name : configmbist.vh\n\
// Author    : Krzysztof Marcinek\n\
// -----------------------------------------------------------------------------\n\
// Automatically generated by tkonfig/mkbist\n\
// -FHDR------------------------------------------------------------------------\n\
\n\
// -----------------------------------------------------------------------------\n\
// mbist parameters\n\
// -----------------------------------------------------------------------------\n\n");

    // integer register file
    regions_number = 1;
    //printf("Adding integer register file:                         %d\n",regions_number);

    // floating point register file
    val = cfgfind("CFG_FPU_EN",&cfgarray);
    if (val>0) {
        regions_number++;
        fpu_en = 1;
        //printf("Adding floating-point register file:                  %d\n",regions_number);
    }

    // icache mem and tags
    val = cfgfind("CFG_ICACHE_EN",&cfgarray);
    if (val>0) {
        regions_number+=2;
        icache_en = 1;
        //printf("Adding instruction cache:                             %d\n",regions_number);
    }

    // dcache mem and tags
    val = cfgfind("CFG_DCACHE_EN",&cfgarray);
    if (val>0) {
        regions_number+=2;
        regions_dualport = 1;
        dcache_en = 1;
        //printf("Adding data cache:                                    %d\n",regions_number);
    }

    // spram
    val = cfgfind("CFG_PMEM_EN",&cfgarray);
    if (val>0) {
        regions_number++;
        spram_en = 1;
        //printf("Adding scratch-pad memory:                            %d\n",regions_number);
    }

    // gnss controller I nad Q fifo
    val = cfgfind("CFG_GNSS_EN",&cfgarray);
    if (val>0) {
        regions_number++;
        gnss_en = 1;
        //printf("Adding GNSS fifos for I and Q:                        %d\n",regions_number);
    }

    // gnss ise code memory
    val = cfgfind("CFG_GNSS_ISE_EN",&cfgarray);
    if (val>0) {
        if (gnss_en) {
            regions_number++;
            //printf("Adding GNSS-ISE code memory:                          %d\n",regions_number);
            gnss_ise_en = 1;
        }
    }

    // fft memory I + Q
    val = cfgfind("CFG_FFT_EN",&cfgarray);
    if (val>0) {
        regions_number++;
        fft_en = 1;
        //printf("Adding FFT memories for I and Q:                      %d\n",regions_number);
        if (spram_en) regions_dualport = 1;
    }

    // eth memory rx + tx fifo plus rx + tx descriptors
    val = cfgfind("CFG_APBBRIDGE2_EN",&cfgarray);
    if (val>0){
        val = cfgfind("CFG_OCETH_NUM",&cfgarray);
        if (val>0) {
            regions_number+=(val);
            eth_num = val;
            //printf("Adding ethernet rx/tx fifos and rx/tx descriptors:    %d\n",regions_number);
        }
    }

    gnss_ise_size = (cfgfind("CFG_GNSS_CMEM_SIZE",&cfgarray)*cfgfind("CFG_GNSS_NUM",&cfgarray))/8;
    fft_size = pow(2,cfgfind("CFG_FFT_SIZE",&cfgarray))*2*4;
    gnss_fifo_size = 2048;
    eth_size = 3072;
    corenum_log = ceil(log2(cfgfind("CFG_CORE_NUM",&cfgarray)));
    if (corenum_log == 0) corenum_log++;

    regions_addr_range = 7;
    if (icache_en)
        if (cfgfind("CFG_ICACHE_SIZE",&cfgarray) > regions_addr_range) regions_addr_range = cfgfind("CFG_ICACHE_SIZE",&cfgarray);
    if (dcache_en)
        if (cfgfind("CFG_DCACHE_SIZE",&cfgarray) > regions_addr_range) regions_addr_range = cfgfind("CFG_DCACHE_SIZE",&cfgarray);
    if (spram_en)
        if (cfgfind("CFG_PMEM_SIZE",&cfgarray) > regions_addr_range) regions_addr_range = cfgfind("CFG_PMEM_SIZE",&cfgarray);
    if (gnss_en)
        if (log2(gnss_fifo_size) > regions_addr_range) regions_addr_range = log2(gnss_fifo_size);
    if (gnss_ise_en)
        if (log2(gnss_ise_size) > regions_addr_range) regions_addr_range = log2(gnss_ise_size);
    if (fft_en)
        if (log2(fft_size) > regions_addr_range) regions_addr_range = log2(fft_size);
    if (eth_num>0)
        if (log2(eth_size) > regions_addr_range) regions_addr_range = log2(eth_size);

    data_width = 32;
    seed_mult = 8;
    if (cfgfind("CFG_ICACHE_FTBITS",&cfgarray) > 0){
        data_width = 40;
        seed_mult = 10;
    }
    if (cfgfind("CFG_DCACHE_FTBITS",&cfgarray) > 0){
        data_width = 40;
        seed_mult = 10;
    }

    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_REGIONS_NUM         = 32'd%d;\n",regions_number);
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_REGIONS_NUM_LOG     = clog2(MBIST_REGIONS_NUM);\n");
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_SEED_NUM            = 32'd3;\n");
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_SEED_NUM_LOG        = clog2(MBIST_SEED_NUM);\n");
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_CORE_NUM            = 32'd%d;\n",cfgfind("CFG_CORE_NUM",&cfgarray));
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_CORE_NUM_LOG        = clog2(MBIST_CORE_NUM);\n\n");

    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_ADDR_WIDTH          = 32'd%d;\n",regions_addr_range);
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_DATA_WIDTH          = 32'd%d;\n",data_width);
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_SEED_WIDTH          = 32'd4;\n");
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_SEED_MULT           = 32'd%d;\n",seed_mult);
    fprintf(fp_mbistconfig,"localparam [31:0] MBIST_DUAL_PORT_EN        = 32'd%d;\n\n",regions_dualport);

    fprintf(fp_mbistconfig,"`ifndef MBIST_CONFIG_PARAMS_ONLY\n\
\n\
// -----------------------------------------------------------------------------\n\
// default single port algorithm\n\
// -----------------------------------------------------------------------------\n\
\n\
    //localparam [31:0] MBIST_SPORT_ALG       = 32'd`MBIST_ONE_ZERO_TEST;\n\
    localparam [31:0] MBIST_SPORT_ALG       = 32'd`MBIST_MARCH_C_MINUS_TEST;\n\
\n\
// -----------------------------------------------------------------------------\n\
// seed array fill\n\
// -----------------------------------------------------------------------------\n\
\n\
    wire    [3:0]           mbistw_seed_array           [MBIST_SEED_NUM-1:0];\n\
\n\
    assign  mbistw_seed_array[0]    = 4'b0000;\n\
    assign  mbistw_seed_array[1]    = 4'b0011;\n\
    assign  mbistw_seed_array[2]    = 4'b0101;\n\
\n\
// -----------------------------------------------------------------------------\n\
// regions wires\n\
// -----------------------------------------------------------------------------\n\
\n\
    wire    [`WIDTH-1:0]                mbistw_region_start_address        [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_region_stop_address         [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_region_mask0                [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_region_mask1                [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_region_mask2                [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_region_mask3                [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_words_in_row                [MBIST_REGIONS_NUM-1:0];\n\
    wire    [`WIDTH-1:0]                mbistw_rows_number                 [MBIST_REGIONS_NUM-1:0];\n\
    wire    [MBIST_CORE_NUM_LOG-1:0]    mbistw_region_startcore            [MBIST_REGIONS_NUM-1:0];\n\
    wire    [MBIST_CORE_NUM_LOG-1:0]    mbistw_region_dualport_startcore   [MBIST_REGIONS_NUM-1:0];\n\
    wire    [MBIST_REGIONS_NUM-1:0]     mbistw_region_multicore;\n\
    wire    [MBIST_REGIONS_NUM-1:0]     mbistw_region_twoport;\n\
    wire    [MBIST_REGIONS_NUM-1:0]     mbistw_region_dualport;\n\
\n\
// -----------------------------------------------------------------------------\n\
// regions array fill\n\
// -----------------------------------------------------------------------------\n\n");

    regions_num = 0;
    fprintf(fp_mbistconfig,"    // integer register file region\n");
    fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h01000000 + (DEBUG_START << 28);\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h0100007c + (DEBUG_START << 28);\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b1;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
    fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
    fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
    fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

    if (fpu_en) {
        regions_num++;
        fprintf(fp_mbistconfig,"    // floating-point register file region\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h01000080 + (DEBUG_START << 28);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h010000fc + (DEBUG_START << 28);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);
    }

    if (icache_en) {

        val = cfgfind("CFG_ICACHE_SIZE",&cfgarray);
        val = pow(2,val);
        val-=4;

        regions_num++;
        fprintf(fp_mbistconfig,"    // instruction cache memory\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h02000000 + (DEBUG_START << 28);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h020%05x + (DEBUG_START << 28);\n",regions_num,val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = %s;\n",regions_num,cfgfind("CFG_ICACHE_FTBITS",&cfgarray) == 4 ? "32'd15" : "32'd0");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

        val = (cfgfind("CFG_ICACHE_SIZE",&cfgarray)-1)-(3+cfgfind("CFG_ILINE_SIZE",&cfgarray));
        val = pow(2,(val+2));
        val-=4;

        regions_num++;
        fprintf(fp_mbistconfig,"    // instruction cache tags\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h02100000 + (DEBUG_START << 28);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h021%05x + (DEBUG_START << 28);\n",regions_num,val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);

        val = cfgfind("CFG_IMEM_BUS",&cfgarray)-cfgfind("CFG_ICACHE_SIZE",&cfgarray)+cfgfind("CFG_ICACHE_FTBITS",&cfgarray)+1;
        val = pow(2,val);
        val--;

        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = 32'd%d;\n",regions_num,val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

    }

    if (dcache_en) {

        val = cfgfind("CFG_DCACHE_SIZE",&cfgarray);
        val = pow(2,val);
        val-=4;

        regions_num++;
        fprintf(fp_mbistconfig,"    // data cache memory\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h02200000 + (DEBUG_START << 28);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h022%05x + (DEBUG_START << 28);\n",regions_num,val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = %s;\n",regions_num,cfgfind("CFG_DCACHE_FTBITS",&cfgarray) == 7 ? "32'd127" : "32'd0");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

        val = (cfgfind("CFG_DCACHE_SIZE",&cfgarray)-1)-(3+cfgfind("CFG_DLINE_SIZE",&cfgarray));
        val = pow(2,(val+2));
        rows = (val/4)/cfgfind("CFG_MBIST_DC_COL_NUM",&cfgarray);
        val-=4;

        regions_num++;
        fprintf(fp_mbistconfig,"    // data cache tags\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h02300000 + (DEBUG_START << 28);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h023%05x + (DEBUG_START << 28);\n",regions_num,val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b1;\n",regions_num);

        val = (cfgfind("CFG_MAX_MEM_BUS",&cfgarray)-cfgfind("CFG_FULLADDR_EN",&cfgarray)-cfgfind("CFG_DCACHE_SIZE",&cfgarray))+cfgfind("CFG_DCACHE_FTBITS",&cfgarray)+1;
        val = pow(2,val);
        val--;

        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = 32'd%d;\n",regions_num,val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd%d;\n",regions_num,cfgfind("CFG_MBIST_DC_COL_NUM",&cfgarray));
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd%d;\n\n",regions_num,rows);

    }

    if (spram_en) {

        val = cfgfind("CFG_PMEM_SIZE",&cfgarray);
        val = pow(2,val);
        rows = (val/4)/cfgfind("CFG_MBIST_SP_COL_NUM",&cfgarray);
        val-=4;

        regions_num++;
        fprintf(fp_mbistconfig,"    // scratch-pad ram memory\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h%01x0000000;\n",regions_num,cfgfind("CFG_PERIPH_RAM",&cfgarray));
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h%01x%07x;\n",regions_num,cfgfind("CFG_PERIPH_RAM",&cfgarray),val);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b%d;\n",regions_num,fft_en);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd%d;\n",regions_num,corenum_log,fft_en?cfgfind("CFG_FFT_START_CORE",&cfgarray):0);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd%d;\n",regions_num,cfgfind("CFG_MBIST_SP_COL_NUM",&cfgarray));
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd%d;\n\n",regions_num,rows);

    }

    if (gnss_en) {

        val = gnss_fifo_size;
        val-=4;

        int GNSS_FIFO_START = 0x6000;
        int GNSS_FIFO_END   = GNSS_FIFO_START + val;

        regions_num++;
        fprintf(fp_mbistconfig,"    // gnss controller I and Q fifos\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h%01x00%01x%04x;\n",regions_num,cfgfind("CFG_PERIPH_START",&cfgarray),cfgfind("CFG_GNSS_BASEADDR",&cfgarray),GNSS_FIFO_START);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h%01x00%01x%04x;\n",regions_num,cfgfind("CFG_PERIPH_START",&cfgarray),cfgfind("CFG_GNSS_BASEADDR",&cfgarray),GNSS_FIFO_END);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

    }

    if (gnss_en && gnss_ise_en) {

        val = gnss_ise_size;
        val-=4;

        int GNSS_CODE_START = 0x8000;
        int GNSS_CODE_END   = GNSS_CODE_START + val;

        regions_num++;
        fprintf(fp_mbistconfig,"    // gnss code memory\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h%01x00%01x%04x;\n",regions_num,cfgfind("CFG_PERIPH_START",&cfgarray),cfgfind("CFG_GNSS_BASEADDR",&cfgarray),GNSS_CODE_START);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h%01x00%01x%04x;\n",regions_num,cfgfind("CFG_PERIPH_START",&cfgarray),cfgfind("CFG_GNSS_BASEADDR",&cfgarray),GNSS_CODE_END);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd%d;\n",regions_num,corenum_log,cfgfind("CFG_GNSS_START_CORE",&cfgarray));
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

    }

    if (fft_en) {

        val = fft_size;
        val-=4;

        int FFT_MEM_START = 0x8000;
        int FFT_MEM_END   = FFT_MEM_START + val;

        regions_num++;
        fprintf(fp_mbistconfig,"    // fft I and Q memory\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h%01x00%01x%04x;\n",regions_num,cfgfind("CFG_PERIPH_START",&cfgarray),cfgfind("CFG_FFT_BASEADDR",&cfgarray),FFT_MEM_START);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h%01x00%01x%04x;\n",regions_num,cfgfind("CFG_PERIPH_START",&cfgarray),cfgfind("CFG_FFT_BASEADDR",&cfgarray),FFT_MEM_END);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b1;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd%d;\n",regions_num,corenum_log,cfgfind("CFG_FFT_START_CORE",&cfgarray));
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

    }

    int i;
    for (i=1;i<=eth_num;i++) {

        val = eth_size;
        val-=4;

        int ETH_START = 0x400;
        int ETH_END   = ETH_START + val;

        regions_num++;
        fprintf(fp_mbistconfig,"    // eth rx/tx and descriptors memory\n");
        fprintf(fp_mbistconfig,"    assign  mbistw_region_start_address[%d]      = 32'h%01x%01x00%01x%03x;\n",regions_num,cfgfind("CFG_AMBA_START",&cfgarray),cfgfind("CFG_APBBRIDGE2_ADDR",&cfgarray),i*cfgfind("CFG_OCETH_S",&cfgarray),ETH_START);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_stop_address[%d]       = 32'h%01x%01x00%01x%03x;\n",regions_num,cfgfind("CFG_AMBA_START",&cfgarray),cfgfind("CFG_APBBRIDGE2_ADDR",&cfgarray),i*cfgfind("CFG_OCETH_S",&cfgarray),ETH_END);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_multicore[%d]          = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_twoport[%d]            = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport[%d]           = 1'b0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask0[%d]              = ~(32'd0);\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask1[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask2[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_mask3[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_startcore[%d]          = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_region_dualport_startcore[%d] = %d'd0;\n",regions_num,corenum_log);
        fprintf(fp_mbistconfig,"    assign  mbistw_words_in_row[%d]              = 32'd0;\n",regions_num);
        fprintf(fp_mbistconfig,"    assign  mbistw_rows_number[%d]               = 32'd0;\n\n",regions_num);

    }

    fprintf(fp_mbistconfig,"`endif\n");

    fclose(fp_configval);
    fclose(fp_mbistconfig);

}
