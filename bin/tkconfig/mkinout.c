/*H*****************************************************************************
*
* Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, version 2.
*
* This program is distributed in the hope that it will be useful, but
* WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
* General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>
*
* ******************************************************************************
* File Name : mkinout.c
* Author    : Krzysztof Marcinek
* ******************************************************************************
* $Date: 2019-03-14 14:47:55 +0100 (Thu, 14 Mar 2019) $
* $Revision: 427 $
*H*****************************************************************************/

#include <dirent.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_CORES 16

char fname[1024];
char fpath[1024];
char line1[1024];
char line2[1024];
char line3[1024];
char line4[1024];
char string[1024];
char start[1024];
char end[1024];
char * tok;
char tok1[1024];
char tok2[1024];
char tokline[1024];
char * i, * m;
char isFile = 0x08;
int j, k, x;
FILE * fin, * fout, * fwire, * finput, * foutput, * foutwire, * fpathdef, * _fout[MAX_CORES], * fwire_array, * funused; //*_fwire[MAX_CORES],

char * replace_str(char * str, char * sub, char * rep) {
    static char buffer[4096];
    static char m[4096];
    char * p;
    strcpy(m, str);
    if ((p = strstr(m, sub)) == NULL)
        return str;
    while ((p = strstr(m, sub)) != NULL) {
        strncpy(buffer, m, p - m);
        buffer[p - m] = '\0';
        sprintf(buffer + (p - m), "%s%s", rep, p + strlen(sub));
        strcpy(m, buffer);
    }
    return buffer;
}

void removecrlf(char * data) {
    int i;
    for (i = 0; i < strlen(data); i++) {
        if (data[i] == '\r')
            data[i] = '\0';
        if (data[i] == '\n')
            data[i] = '\0';
    }
}

void removecr(char * data) {
    int i;
    for (i = 0; i < strlen(data); i++) {
        if (data[i] == '\r') {
            data[i] = '\n';
            data[i + 1] = '\0';
            return;
        }
    }
}

int main(int argc, char * argv[]) {
    DIR * d;
    char * tok;
    struct dirent * dir;
    if (argc < 4) {
        printf("too few arguments\n");
        exit(1);
    }
    d = opendir(argv[1]);
    if (d) {

        fname[0] = '\0';
        strcat(fpath, argv[2]);
        strcat(fpath, "/paths.vh");
        strcat(fpath, fname);
        fpathdef = fopen(fpath, "w");
        if (!fpathdef) {
            printf("could not open file %s\n", fpath);
            exit(1);
        }

        sprintf(start, "// +FHDR------------------------------------------------------------------------\n\
//\n\
// Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved\n\
//\n\
// -----------------------------------------------------------------------------\n\
// Author    : Krzysztof Marcinek\n\
// -----------------------------------------------------------------------------\n\
// Automatically generated by tkonfig/mkinout\n\
// -FHDR------------------------------------------------------------------------\n\n\
");

        fprintf(fpathdef, "%s", start);
        fprintf(fpathdef, "`ifndef __FPATH_DEF__\n`define __FPATH_DEF__\n\n");
        while ((dir = readdir(d)) != NULL) {
            fname[0] = '\0';
            if (strstr(dir->d_name, ".v") != NULL) {
                for (x = 0; x < strlen(dir->d_name); x++) {
                    if (dir->d_name[x] == '.') {
                        string[x] = '\0';
                        break;
                    } else
                        string[x] = toupper(dir->d_name[x]);
                }

                fprintf(fpathdef, "`define IN_%s \"in_%s\"\n", string, dir->d_name);
                fprintf(fpathdef, "`define OUT_%s \"out_%s\"\n", string, dir->d_name);
                fprintf(fpathdef, "`define OUTW_%s \"outw_%s\"\n", string, dir->d_name);
                fprintf(fpathdef, "`define SIM_%s \"sim_%s\"\n", string, dir->d_name);
                for (k = 0; k < MAX_CORES; k++) {
                    fprintf(fpathdef, "`define SIM_%s_%d \"%d_sim_%s\"\n", string, k, k, dir->d_name);
                }
                fprintf(fpathdef, "`define WIRE_%s \"wire_%s\"\n", string, dir->d_name);
                fprintf(fpathdef, "`define WIRE_ARRAY_%s \"wire_array_%s\"\n", string, dir->d_name);
                for (k = 0; k < MAX_CORES; k++) {
                    fprintf(fpathdef, "`define WIRE_%s_%d \"%d_wire_%s\"\n", string, k, k, dir->d_name);
                }

                sprintf(fname, "in_%s", dir->d_name);
                sprintf(fpath, "%s/auto/%s", argv[1], fname);
                finput = fopen(fpath, "w");
                if (!finput) {
                    printf("could not open file %s\n", fname);
                    exit(1);
                }
                sprintf(fname, "out_%s", dir->d_name);
                sprintf(fpath, "%s/auto/%s", argv[1], fname);
                foutput = fopen(fpath, "w");
                if (!foutput) {
                    printf("could not open file %s\n", fname);
                    exit(1);
                }
                sprintf(fname, "outw_%s", dir->d_name);
                sprintf(fpath, "%s/auto/%s", argv[1], fname);
                foutwire = fopen(fpath, "w");
                if (!foutwire) {
                    printf("could not open file %s\n", fname);
                    exit(1);
                }
                sprintf(fname, "sim_%s", dir->d_name);
                sprintf(fpath, "%s/auto/%s", argv[1], fname);
                fout = fopen(fpath, "w");
                if (!fout) {
                    printf("could not open file %s\n", fname);
                    exit(1);
                }
                for (k = 0; k < MAX_CORES; k++) {
                    sprintf(fname, "%d_sim_%s", k, dir->d_name);
                    sprintf(fpath, "%s/auto/%s", argv[1], fname);
                    _fout[k] = fopen(fpath, "w");
                    if (!_fout[k]) {
                        printf("could not open file %s\n", fname);
                        exit(1);
                    }
                }
                sprintf(fname, "wire_%s", dir->d_name);
                sprintf(fpath, "%s/auto/%s", argv[1], fname);
                fwire = fopen(fpath, "w");
                if (!fwire) {
                    printf("could not open file %s\n", fname);
                    exit(1);
                }
                sprintf(fname, "wire_array_%s", dir->d_name);
                sprintf(fpath, "%s/auto/%s", argv[1], fname);
                fwire_array = fopen(fpath, "w");
                if (!fwire_array) {
                    printf("could not open file %s\n", fname);
                    exit(1);
                }

                sprintf(fpath, "%s/%s", argv[1], dir->d_name);
                fin = fopen(fpath, "r");
                if (!fin) {
                    printf("could not open file %s\n", dir->d_name);
                    printf("Error: %m\n");
                    fclose(fout);
                    exit(1);
                }

                fprintf(fout, "%s", start);
                fprintf(foutput, "%s", start);
                fprintf(finput, "%s", start);
                fprintf(foutwire, "%s", start);
                fprintf(fwire, "%s", start);
                fprintf(fwire_array, "%s", start);
                //fprintf(funused,"%s",start);
                for (k = 0; k < MAX_CORES; k++) {
                    fprintf(_fout[k], "%s", start);
                }

                x = 0;
                while (fgets(line1, sizeof(line1), fin)) {

                    // remove comments
                    if (strstr(line1, "/*") != 0) {
                        tok = strstr(line1, ",");
                        tok++; * tok = '\n';
                        tok++; * tok = '\0';
                    }

                    // remove multiple spaces
                    m = replace_str((char * ) line1, "  ", " ");
                    if (m[0] == ' ')
                        strcpy(line1, m + 1);
                    else
                        strcpy(line1, m);

                    if (strstr(line1, "//") != 0) continue;
                    removecr(line1);
                    if (strlen(line1) < 2) continue;
                    if ((i = strstr(line1, "]")) == NULL) {
                        fprintf(fout, "%s", line1);
                        strcpy(line4, line1);
                        if (line4[strlen(line4) - 2] == ',')
                            line4[strlen(line4) - 2] = 0;
                        else
                            line4[strlen(line4) - 1] = 0;
                    } else {
                        m = strstr(i + 2, "[");
                        if (m == NULL) {
                            fprintf(fout, "%s", i + 2);
                            strcpy(line4, i + 2);
                            line4[strlen(line4) - 2] = 0;
                        } else {
                            strncpy(line3, i + 2, m - i - 2);
                            line3[m - i - 3] = ',';
                            line3[m - i - 2] = '\n';
                            line3[m - i - 1] = '\0';
                            fprintf(fout, "%s", line3);
                            strcpy(line4, line3);
                            line4[strlen(line4) - 2] = 0;
                        }
                    }
                    for (k = 0; k < MAX_CORES; k++) {
                        i = strchr(line1, ' ');
                        if (i != NULL)
                            strcpy(line2, i + 1);
                        else
                            strcpy(line2, line1);
                        removecrlf(line2);
                        i = strchr(line2, ' ');
                        if (i) { * (i + 1) = '\0';
                        }
                        j = strlen(line2) - 1;
                        line2[j] = '[';
                        fprintf(_fout[k], "%s%d]%s", line2, k, ",\n");
                    }
                    if (strlen(line1) > 2) {
                        fprintf(finput, "input wire ");
                        fprintf(finput, "%s", line1);
                        fprintf(foutput, "output reg ");
                        fprintf(foutput, "%s", line1);
                        fprintf(foutwire, "output wire ");
                        fprintf(foutwire, "%s", line1);
                        for (j = 0; j < strlen(line1); j++) {
                            if (line1[j] == ',') line1[j] = ';';
                        }
                        fprintf(fwire, "wire ");
                        if (line1[strlen(line1) - 2] == ';') {
                            fprintf(fwire, "%s", line1);
                        } else {
                            line1[strlen(line1) - 1] = '\0';
                            fprintf(fwire, "%s;\n", line1);
                        }

                        fprintf(fwire_array, "wire ");
                        m = strstr(line1, "[");
                        sprintf(line3, line1);

                        if (m == NULL) {
                            fprintf(fwire_array, "[%s-1:0] %s", argv[3], line3);
                        } else {
                            m = strstr(m + 1, "[");
                            if (m == NULL) {
                                m = strstr(line3, ";");
                                if (m != NULL) {
                                    sprintf(m, " [%s-1:0];\n", argv[3]);
                                    fprintf(fwire_array, "%s", line3);
                                } else {
                                    printf("inout error\n");
                                    exit(1);
                                }
                            } else {
                                fprintf(fwire_array, "%s", line3);
                            }
                        }

                    }
                }

                sprintf(end, "\n// -----------------------------------------------------------------------------\n\
// end of automatic configuration\n\
// -----------------------------------------------------------------------------\n");

                fprintf(fout, "%s", end);
                fprintf(fwire, "%s", end);
                fprintf(fwire_array, "%s", end);
                fprintf(finput, "%s", end);
                fprintf(foutput, "%s", end);
                fprintf(foutwire, "%s", end);
                for (k = 0; k < MAX_CORES; k++) {
                    fprintf(_fout[k], "%s", end);
                }

                fclose(fin);
                fclose(fout);
                for (k = 0; k < MAX_CORES; k++)
                    fclose(_fout[k]);
                fclose(fwire);
                fclose(fwire_array);
                fclose(finput);
                fclose(foutput);
                fclose(foutwire);
            }
        }
        fprintf(fpathdef, "\n`endif // __FPATH_DEF__\n");
        fprintf(fpathdef, "%s", end);
        fclose(fpathdef);
        closedir(d);

    } else {
        printf("could not open directory\n");
        exit(1);
    }

    return (0);
}
