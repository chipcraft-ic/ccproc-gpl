/*H*****************************************************************************
*
* Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, version 2.
*
* This program is distributed in the hope that it will be useful, but
* WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
* General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>
*
* ******************************************************************************
* File Name : mkdefine.c
* Author    : Krzysztof Marcinek
* ******************************************************************************
* $Date: 2019-03-14 14:47:55 +0100 (Thu, 14 Mar 2019) $
* $Revision: 427 $
*H*****************************************************************************/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#define MAX_CORES 32

FILE * def;
FILE * inst;
FILE * val;

int i;

int cfgreg = 0;

char endline[] = " ";

static const char header1[] = "// +FHDR------------------------------------------------------------------------\n\
//\n\
// Copyright (c) 2017 ChipCraft Sp. z o.o. All rights reserved\n\
//\n\
// -----------------------------------------------------------------------------\n\
// File Name : ";

static const char header2[] = ".vh\n\
// Author    : Krzysztof Marcinek\n\
// -----------------------------------------------------------------------------\n\
// Automatically generated by tkonfig/mkdefine\n\
// -FHDR------------------------------------------------------------------------\n\
";

static const char footer[] = "\n\
\n\
// -----------------------------------------------------------------------------\n\
// end of automatic configuration\n\
// -----------------------------------------------------------------------------\n\
\n\
";

main() {

    char lbuf[1024], * value, * cfgline, * delim;

    def = fopen("configdef.vh", "w+");
    inst = fopen("configinst.vh", "w+");
    val = fopen("configval.vh", "w+");
    if (!def) {
        printf("could not open file configdef.vh\n");
        exit(1);
    }
    if (!inst) {
        printf("could not open file configinst.vh\n");
        exit(1);
    }

    fprintf(def,"%sconfigdef%s",header1,header2);
    fprintf(inst,"%sconfiginst%s\n\n",header1,header2);
    fprintf(val,"%sconfigval%s\n\n",header1,header2);

    while (!feof(stdin)) {
        lbuf[0] = 0;
        fgets(lbuf, 1023, stdin);
        if (strncmp(lbuf, "    .CFG_", 9) == 0) {

            cfgline = lbuf + 5;
            value = strchr(cfgline, 'd');
            value[0] = 0;
            value++;
            delim = strchr(cfgline, '(');
            delim[0] = 0;

            while ((strlen(value) > 0) &&
                  ((value[strlen(value) - 1] == '\n') ||
                   (value[strlen(value) - 1] == '\r')))
                value[strlen(value) - 1] = 0;

            endline[0] = ',';
            if (value[strlen(value) - 1] != ',')
                endline[0] = 0;

            while ((strlen(value) > 0) &&
                  ((value[strlen(value) - 1] == ',') ||
                   (value[strlen(value) - 1] == ')')))
                value[strlen(value) - 1] = 0;

            /* ----------------------------------------------------------------------- */
            /* -- Evaluate variables value                                             */
            /* ----------------------------------------------------------------------- */

            if (strcmp("CFG_CFGREG_EN", cfgline) == 0) {
                if (atoi(value) > 0)
                    cfgreg++;
            }

            fprintf(inst,"    .%s(%s)%s\n",cfgline,cfgline,endline);
            fprintf(val,"    parameter [31:0] %s = 32'd%s%s\n",cfgline,value,endline);

        }
    }

    if (cfgreg) {
        fprintf(def, "\n    `define DEF_CFG_CFGREG_EN");
    } else {
        fprintf(def, "\n    `undef DEF_CFG_CFGREG_EN");
    }

    fprintf(def, "%s", footer);
    fprintf(inst, "%s", footer);
    fprintf(val, "%s", footer);

    fclose(def);
    fclose(inst);
    fclose(val);
    return (0);
}
